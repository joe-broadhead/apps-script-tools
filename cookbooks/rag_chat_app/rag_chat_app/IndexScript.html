<script>
  (function () {
    var state = {
      initialized: false,
      pending: false,
      pendingIndexPoll: false,
      app: {},
      runtime: {},
      permissions: {
        isAdmin: false,
        canMutateIndex: false,
        canWarmModels: false
      },
      index: {},
      threads: { activeThreadId: '', list: [] },
      activeThread: { id: '', title: '', turns: [] }
    };

    var els = {};

    document.addEventListener('DOMContentLoaded', function () {
      cacheElements_();
      bindEvents_();
      initialize_();
    });

    function cacheElements_() {
      els.appName = document.getElementById('appName');
      els.appTagline = document.getElementById('appTagline');
      els.brandLogo = document.getElementById('brandLogo');
      els.brandLogoFallback = document.getElementById('brandLogoFallback');
      els.newThreadBtn = document.getElementById('newThreadBtn');
      els.syncIndexBtn = document.getElementById('syncIndexBtn');
      els.rebuildIndexBtn = document.getElementById('rebuildIndexBtn');
      els.threadList = document.getElementById('threadList');
      els.threadCountBadge = document.getElementById('threadCountBadge');
      els.modeDeepToggle = document.getElementById('modeDeepToggle');
      els.indexMeta = document.getElementById('indexMeta');
      els.welcomeCard = document.getElementById('welcomeCard');
      els.messages = document.getElementById('messages');
      els.chatForm = document.getElementById('chatForm');
      els.chatInput = document.getElementById('chatInput');
      els.sendBtn = document.getElementById('sendBtn');
      els.statusLine = document.getElementById('statusLine');
    }

    function bindEvents_() {
      els.chatForm.addEventListener('submit', onSubmit_);
      els.chatInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          onSubmit_(event);
        }
      });
      els.newThreadBtn.addEventListener('click', onNewThread_);
      els.syncIndexBtn.addEventListener('click', onSyncIndex_);
      els.rebuildIndexBtn.addEventListener('click', onRebuildIndex_);
      els.threadList.addEventListener('click', onThreadListClick_);
    }

    function initialize_() {
      setBusy_(true, 'Initializing app...');
      callServer_('initAppWeb', {})
        .then(function (result) {
          hydrateFromInit_(result || {});
          setBusy_(false, 'Ready.');
        })
        .catch(function (error) {
          onFatalError_(error);
        });
    }

    function hydrateFromInit_(payload) {
      state.initialized = true;
      state.app = payload.app || {};
      state.runtime = payload.runtime || {};
      state.permissions = payload.permissions || state.permissions;
      state.index = payload.index || {};
      state.threads = payload.threads || { activeThreadId: '', list: [] };
      state.activeThread = payload.activeThread || { id: '', title: '', turns: [] };

      applyBranding_();
      applyPermissions_();
      renderThreadList_();
      renderMessages_();
      renderIndexMeta_();
      updateIndexPendingState_();

      if (state.app.placeholder) {
        els.chatInput.placeholder = state.app.placeholder;
      }
    }

    function applyBranding_() {
      var app = state.app || {};
      var palette = app.palette || {};
      var rootStyle = document.documentElement.style;
      var map = {
        '--color-primary': palette.primary,
        '--color-accent': palette.accent,
        '--color-bg-start': palette.bgStart,
        '--color-bg-end': palette.bgEnd,
        '--color-surface': palette.surface,
        '--color-text': palette.text,
        '--color-muted': palette.muted
      };

      Object.keys(map).forEach(function (key) {
        if (map[key]) rootStyle.setProperty(key, map[key]);
      });

      if (app.fontFamily) {
        rootStyle.setProperty('--font-family', app.fontFamily);
      }

      // Keep glass tones aligned with user palette.
      var primaryRgb = parseCssColorToRgb_(palette.primary);
      if (primaryRgb) {
        rootStyle.setProperty('--color-primary-soft', rgbaString_(primaryRgb, 0.14));
        rootStyle.setProperty('--color-primary-ring', rgbaString_(primaryRgb, 0.2));
      }

      var accentRgb = parseCssColorToRgb_(palette.accent);
      if (accentRgb) {
        rootStyle.setProperty('--color-accent-soft', rgbaString_(accentRgb, 0.16));
      }

      var textRgb = parseCssColorToRgb_(palette.text);
      if (textRgb) {
        rootStyle.setProperty('--color-border', rgbaString_(textRgb, 0.12));
        rootStyle.setProperty('--color-shadow', rgbaString_(textRgb, 0.1));
      }

      if (app.name) {
        els.appName.textContent = app.name;
        document.title = app.name;
      }
      if (app.tagline) {
        els.appTagline.textContent = app.tagline;
      }

      if (app.logoUrl) {
        els.brandLogo.src = app.logoUrl;
        els.brandLogo.classList.remove('hidden');
        if (els.brandLogoFallback) {
          els.brandLogoFallback.style.display = 'none';
        }
      } else {
        els.brandLogo.removeAttribute('src');
        els.brandLogo.classList.add('hidden');
        if (els.brandLogoFallback) {
          els.brandLogoFallback.style.display = '';
        }
      }
    }

    function applyPermissions_() {
      var canMutateIndex = state.permissions && state.permissions.canMutateIndex === true;

      if (!canMutateIndex) {
        els.syncIndexBtn.disabled = true;
        els.rebuildIndexBtn.disabled = true;
        els.syncIndexBtn.title = 'Admin permission required';
        els.rebuildIndexBtn.title = 'Admin permission required';
      } else {
        els.syncIndexBtn.disabled = false;
        els.rebuildIndexBtn.disabled = false;
        els.syncIndexBtn.title = '';
        els.rebuildIndexBtn.title = '';
      }
    }

    function renderThreadList_() {
      var threads = (state.threads && state.threads.list) || [];
      var activeId = state.threads ? state.threads.activeThreadId : '';

      els.threadCountBadge.textContent = String(threads.length || 0);
      els.threadList.innerHTML = '';

      if (!threads.length) {
        var empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.textContent = 'No threads yet. Start your first question.';
        els.threadList.appendChild(empty);
        return;
      }

      for (var i = 0; i < threads.length; i += 1) {
        var thread = threads[i] || {};
        var button = document.createElement('button');
        button.className = 'thread-item' + (thread.id === activeId ? ' active' : '');
        button.type = 'button';
        button.dataset.threadId = thread.id || '';

        var title = document.createElement('div');
        title.className = 'thread-title';
        title.textContent = thread.title || 'Untitled';
        button.appendChild(title);

        var preview = document.createElement('div');
        preview.className = 'thread-preview';
        preview.textContent = thread.preview || safeTimeLabel_(thread.updatedAt);
        button.appendChild(preview);

        els.threadList.appendChild(button);
      }
    }

    function renderMessages_() {
      var thread = state.activeThread || {};
      var turns = Array.isArray(thread.turns) ? thread.turns : [];

      els.messages.innerHTML = '';
      els.welcomeCard.style.display = turns.length ? 'none' : '';

      for (var i = 0; i < turns.length; i += 1) {
        renderTurn_(turns[i]);
      }

      scrollToBottom_();
    }

    function renderTurn_(turn) {
      turn = turn || {};

      var userBubble = createBubble_('user', 'You', turn.q || '', null, null);
      els.messages.appendChild(userBubble);

      var metaBits = [];
      if (turn.deep === true) metaBits.push('deep');
      if (turn.model) metaBits.push(turn.model);
      if (turn.status) metaBits.push(turn.status);

      var assistantBubble = createBubble_(
        'assistant',
        'AST',
        turn.a || '',
        metaBits.join(' | '),
        turn.citations || []
      );
      els.messages.appendChild(assistantBubble);
    }

    function createBubble_(roleClass, roleLabel, bodyText, metaText, citations) {
      var wrapper = document.createElement('article');
      wrapper.className = 'bubble ' + roleClass;

      var head = document.createElement('div');
      head.className = 'bubble-head';
      head.innerHTML =
        '<span>' + escapeHtml_(roleLabel) + '</span>' +
        '<span>' + escapeHtml_(metaText || '') + '</span>';
      wrapper.appendChild(head);

      var body = document.createElement('div');
      body.className = 'bubble-content';
      body.textContent = bodyText || '';
      wrapper.appendChild(body);

      if (Array.isArray(citations) && citations.length) {
        var list = document.createElement('div');
        list.className = 'bubble-citations';

        for (var i = 0; i < citations.length; i += 1) {
          var citation = citations[i] || {};
          var chip = document.createElement('a');
          chip.className = 'citation-chip';
          if (citation.url) {
            chip.target = '_blank';
            chip.rel = 'noopener noreferrer';
            chip.href = citation.url;
          } else {
            chip.className += ' disabled';
            chip.removeAttribute('href');
            chip.setAttribute('role', 'note');
          }
          chip.textContent = (citation.citationId || 'S?') + ' | ' + (citation.fileName || 'Source');
          chip.title = citation.snippet || citation.fileName || 'Source';
          list.appendChild(chip);
        }

        wrapper.appendChild(list);
      }

      return wrapper;
    }

    function renderIndexMeta_() {
      var info = state.index && state.index.info;
      if (!info) {
        var pending = state.index && state.index.pendingJob;
        if (pending && pending.status) {
          els.indexMeta.textContent = 'Index: preparing (' + pending.status + ')';
        } else {
          els.indexMeta.textContent = 'Index: unavailable';
        }
        return;
      }
      var name = info.indexName || 'index';
      var chunks = Number(info.chunkCount || 0);
      var sources = Number(info.sourceCount || 0);
      els.indexMeta.textContent = 'Index: ' + name + ' | ' + sources + ' sources | ' + chunks + ' chunks';
    }

    function updateIndexPendingState_() {
      var pendingJob = state.index && state.index.pendingJob;
      var isPending = !!(pendingJob && (pendingJob.status === 'queued' || pendingJob.status === 'running' || pendingJob.status === 'paused'));

      if (isPending) {
        els.statusLine.textContent = 'Index is preparing (' + pendingJob.status + '). Chat will unlock when ready.';
        startIndexJobPoll_();
      } else {
        stopIndexJobPoll_();
      }
    }

    function startIndexJobPoll_() {
      if (state.pendingIndexPoll) return;
      state.pendingIndexPoll = true;
      pollIndexJobStatus_();
    }

    function stopIndexJobPoll_() {
      state.pendingIndexPoll = false;
    }

    function pollIndexJobStatus_() {
      if (!state.pendingIndexPoll) return;
      if (state.pending) {
        setTimeout(pollIndexJobStatus_, 4000);
        return;
      }

      callServer_('indexJobStatusWeb', {})
        .then(function (payload) {
          var job = payload && payload.job ? payload.job : null;
          if (job && (job.status === 'queued' || job.status === 'running' || job.status === 'paused')) {
            state.index = state.index || {};
            state.index.pendingJob = job;
            renderIndexMeta_();
            setTimeout(pollIndexJobStatus_, 4000);
            return;
          }

          callServer_('getIndexStateWeb', {})
            .then(function (indexPayload) {
              state.index = indexPayload && indexPayload.index ? indexPayload.index : state.index;
              renderIndexMeta_();
              updateIndexPendingState_();
            })
            .catch(function () {
              stopIndexJobPoll_();
            });
        })
        .catch(function () {
          setTimeout(pollIndexJobStatus_, 5000);
        });
    }

    function onSubmit_(event) {
      if (event && event.preventDefault) event.preventDefault();
      if (state.pending) return;

      var pendingJob = state.index && state.index.pendingJob;
      var hasIndex = !!(state.index && state.index.indexFileId);
      if (!hasIndex && pendingJob && (pendingJob.status === 'queued' || pendingJob.status === 'running' || pendingJob.status === 'paused')) {
        setBusy_(false, 'Index is still building (' + pendingJob.status + ').');
        startIndexJobPoll_();
        return;
      }

      var message = (els.chatInput.value || '').trim();
      if (!message) return;

      var request = {
        message: message,
        threadId: state.threads ? state.threads.activeThreadId : '',
        deep: els.modeDeepToggle.checked === true
      };

      els.chatInput.value = '';
      setBusy_(true, 'Running ' + (request.deep ? 'Deep' : 'Fast') + ' query...');

      callServer_('chatTurnWeb', request)
        .then(function (result) {
          handleChatResponse_(result || {});
        })
        .catch(function (error) {
          setBusy_(false, 'Request failed.');
          renderInlineError_(error);
        });
    }

    function handleChatResponse_(result) {
      state.threads = result.threads || state.threads;
      state.activeThread = result.thread || state.activeThread;
      state.index = state.index || {};
      if (result.index && result.index.pendingJob) {
        state.index.pendingJob = result.index.pendingJob;
      }
      if (state.threads && !state.threads.activeThreadId && result.threadId) {
        state.threads.activeThreadId = result.threadId;
      }

      renderThreadList_();
      renderMessages_();

      var diagnostics = result.diagnostics || {};
      var status = [
        'mode=' + (diagnostics.mode || 'fast'),
        'status=' + (result.status || 'ok'),
        'path=' + (diagnostics.path || 'rag'),
        'cached=' + (diagnostics.cached === true ? 'true' : 'false'),
        'total=' + String(diagnostics.totalMs || 0) + 'ms'
      ].join(' | ');
      setBusy_(false, status);
      updateIndexPendingState_();
    }

    function onNewThread_() {
      if (state.pending) return;
      setBusy_(true, 'Creating thread...');
      callServer_('newThreadWeb', { title: 'New chat' })
        .then(function (result) {
          state.threads = result.threads || state.threads;
          state.activeThread = result.activeThread || { id: '', title: '', turns: [] };
          renderThreadList_();
          renderMessages_();
          els.chatInput.focus();
          setBusy_(false, 'Ready.');
        })
        .catch(function (error) {
          setBusy_(false, 'Failed to create thread.');
          renderInlineError_(error);
        });
    }

    function onThreadListClick_(event) {
      var target = event.target;
      if (!target) return;
      var button = target.closest('button[data-thread-id]');
      if (!button) return;
      if (state.pending) return;

      var threadId = button.dataset.threadId || '';
      if (!threadId || (state.threads && state.threads.activeThreadId === threadId)) return;

      setBusy_(true, 'Loading thread...');
      callServer_('switchThreadWeb', { threadId: threadId })
        .then(function (result) {
          state.threads = result.threads || state.threads;
          state.activeThread = result.activeThread || state.activeThread;
          renderThreadList_();
          renderMessages_();
          setBusy_(false, 'Ready.');
        })
        .catch(function (error) {
          setBusy_(false, 'Failed to load thread.');
          renderInlineError_(error);
        });
    }

    function onSyncIndex_() {
      if (state.pending) return;
      setBusy_(true, 'Syncing index...');
      callServer_('syncIndexWeb', {})
        .then(function (result) {
          state.index = result.index || state.index;
          renderIndexMeta_();
          setBusy_(false, 'Index synced.');
        })
        .catch(function (error) {
          setBusy_(false, 'Index sync failed.');
          renderInlineError_(error);
        });
    }

    function onRebuildIndex_() {
      if (state.pending) return;
      if (!window.confirm('Rebuild the index from source folder?')) return;

      setBusy_(true, 'Rebuilding index...');
      callServer_('rebuildIndexWeb', {})
        .then(function (result) {
          state.index = result.index || state.index;
          renderIndexMeta_();
          setBusy_(false, 'Index rebuilt.');
        })
        .catch(function (error) {
          setBusy_(false, 'Index rebuild failed.');
          renderInlineError_(error);
        });
    }

    function renderInlineError_(error) {
      var text = formatError_(error);
      var bubble = createBubble_('assistant', 'AST', 'Error: ' + text, 'error', null);
      els.messages.appendChild(bubble);
      scrollToBottom_();
      if (/index is still building|index is currently being prepared/i.test(text)) {
        startIndexJobPoll_();
      }
    }

    function setBusy_(busy, statusMessage) {
      state.pending = busy === true;
      els.sendBtn.disabled = state.pending;
      els.chatInput.disabled = state.pending;
      els.newThreadBtn.disabled = state.pending;
      var canMutateIndex = state.permissions && state.permissions.canMutateIndex === true;
      els.syncIndexBtn.disabled = state.pending || !canMutateIndex;
      els.rebuildIndexBtn.disabled = state.pending || !canMutateIndex;
      els.modeDeepToggle.disabled = state.pending;
      els.statusLine.textContent = statusMessage || (state.pending ? 'Working...' : 'Ready.');

      if (!state.pending) {
        els.chatInput.focus();
      }
    }

    function callServer_(method, payload) {
      return new Promise(function (resolve, reject) {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          reject(new Error('google.script.run is unavailable in this context.'));
          return;
        }

        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)[method](payload || {});
      });
    }

    function onFatalError_(error) {
      state.initialized = false;
      setBusy_(false, 'Initialization failed.');
      renderInlineError_(error);
    }

    function formatError_(error) {
      if (!error) return 'Unknown error';
      if (typeof error === 'string') return error;
      return String(error.message || error.toString() || 'Unknown error');
    }

    function safeTimeLabel_(epochMs) {
      if (!epochMs) return '';
      var date = new Date(epochMs);
      if (isNaN(date.getTime())) return '';
      return date.toLocaleString();
    }

    function scrollToBottom_() {
      window.requestAnimationFrame(function () {
        var node = document.getElementById('chatView');
        if (!node) return;
        node.scrollTop = node.scrollHeight;
      });
    }

    function escapeHtml_(value) {
      return String(value == null ? '' : value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function parseCssColorToRgb_(value) {
      var text = String(value == null ? '' : value).trim();
      if (!text) return null;

      // #rgb or #rrggbb
      var hexMatch = text.match(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/);
      if (hexMatch) {
        var hex = hexMatch[1];
        if (hex.length === 3) {
          hex = hex.charAt(0) + hex.charAt(0) +
            hex.charAt(1) + hex.charAt(1) +
            hex.charAt(2) + hex.charAt(2);
        }
        return {
          r: parseInt(hex.slice(0, 2), 16),
          g: parseInt(hex.slice(2, 4), 16),
          b: parseInt(hex.slice(4, 6), 16)
        };
      }

      // rgb(r,g,b)
      var rgbMatch = text.match(/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/i);
      if (rgbMatch) {
        return {
          r: clampChannel_(Number(rgbMatch[1])),
          g: clampChannel_(Number(rgbMatch[2])),
          b: clampChannel_(Number(rgbMatch[3]))
        };
      }

      return null;
    }

    function rgbaString_(rgb, alpha) {
      var a = Number(alpha);
      if (!isFinite(a) || a < 0) a = 0;
      if (a > 1) a = 1;
      return 'rgba(' + clampChannel_(rgb.r) + ', ' + clampChannel_(rgb.g) + ', ' + clampChannel_(rgb.b) + ', ' + a + ')';
    }

    function clampChannel_(n) {
      n = Number(n);
      if (!isFinite(n)) return 0;
      if (n < 0) return 0;
      if (n > 255) return 255;
      return Math.round(n);
    }
  })();
</script>
